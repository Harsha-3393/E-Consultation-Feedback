<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2 class="sidebar-title">E-Consultation</h2>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li><a href="{{ url_for('comments_view') }}">Comments View</a></li>
                    <li class="active"><a href="{{ url_for('analytics') }}">Analytics</a></li>
                </ul>
            </nav>
            <div class="sidebar-form-section">
                <h3>+ Add Comment</h3>
                <form id="add-comment-form">
                    <label for="comment_text">Comment text:</label>
                    <textarea id="comment_text" name="comment_text" rows="4"></textarea>
                    
                    <label for="author">Author (optional):</label>
                    <input type="text" id="author" name="author">

                    <button type="submit">Add Comment</button>
                    <button type="button" id="analyze-all-btn">Analyze All Comments</button>
                    <button type="button" id="clear-all-btn">Clear All Comments</button>
                    <button type="button" id="download-excel-btn">Download Excel</button>
                </form>
            </div>
        </aside>
        
        <main class="main-content">
            <h1>Analytics</h1>
            <p class="subtitle">Visual insights into comment data.</p>
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Sentiment Distribution</h3>
                    <canvas id="sentiment-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Intent Distribution</h3>
                    <canvas id="intent-chart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/analytics_data')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    // Check if data is available for charts
                    const sentimentExists = Object.keys(data.sentiment_data).length > 0;
                    const intentExists = Object.keys(data.intent_data).length > 0;

                    if (!sentimentExists && !intentExists) {
                        document.getElementById('sentiment-chart').parentElement.innerHTML = '<h3>No data to display.</h3>';
                        document.getElementById('intent-chart').parentElement.innerHTML = '<h3>No data to display.</h3>';
                        return;
                    }

                    // Sentiment Chart
                    if (sentimentExists) {
                        const sentimentLabels = Object.keys(data.sentiment_data);
                        const sentimentValues = Object.values(data.sentiment_data);
                        
                        const sentimentCtx = document.getElementById('sentiment-chart').getContext('2d');
                        new Chart(sentimentCtx, {
                            type: 'pie',
                            data: {
                                labels: sentimentLabels,
                                datasets: [{
                                    data: sentimentValues,
                                    backgroundColor: ['#2e7d32', '#c62828', '#ef6c00', '#7f8c8d', '#2c3e50']
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    }
                                }
                            }
                        });
                    } else {
                        document.getElementById('sentiment-chart').parentElement.innerHTML = '<h3>No sentiment data.</h3>';
                    }

                    // Intent Chart
                    if (intentExists) {
                        const intentLabels = Object.keys(data.intent_data);
                        const intentValues = Object.values(data.intent_data);

                        const intentCtx = document.getElementById('intent-chart').getContext('2d');
                        new Chart(intentCtx, {
                            type: 'bar',
                            data: {
                                labels: intentLabels,
                                datasets: [{
                                    label: 'Number of Comments',
                                    data: intentValues,
                                    backgroundColor: '#4a4a99'
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    } else {
                        document.getElementById('intent-chart').parentElement.innerHTML = '<h3>No intent data.</h3>';
                    }
                })
                .catch(error => console.error('Error fetching analytics data:', error));
        });
    </script>
</body>
</html>